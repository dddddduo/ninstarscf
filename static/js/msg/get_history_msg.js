function getHistoryMsgCallback(msgList,prepage){var msg;prepage=prepage||false;if(prepage){msgList.reverse();}for(var j in msgList){msg=msgList[j];if(msg.getSession().id()==selToID){selSess=msg.getSession();addMsg(msg,prepage);}}webim.setAutoRead(selSess,true,true);}var getLastC2CHistoryMsgs=function(cbOk,cbError){if(selType==webim.SESSION_TYPE.GROUP){alert('当前的聊天类型为群聊天，不能进行拉取好友历史消息操作');return;}if(!selToID||selToID=='@TIM#SYSTEM'){alert('当前的聊天id非法，selToID='+selToID);return;}var lastMsgTime=0;var msgKey='';var options={'Peer_Account':selToID,'MaxCnt':reqMsgCount,'LastMsgTime':lastMsgTime,'MsgKey':msgKey};selSess=null;webim.MsgStore.delSessByTypeId(selType,selToID);webim.getC2CHistoryMsgs(options,function(resp){var complete=resp.Complete;if(resp.MsgList.length==0){webim.Log.warn("没有历史消息了:data="+JSON.stringify(options));return;}getPrePageC2CHistroyMsgInfoMap[selToID]={'LastMsgTime':resp.LastMsgTime,'MsgKey':resp.MsgKey};document.getElementsByClassName("msgflow")[0].innerHTML="";if(cbOk)cbOk(resp.MsgList);},cbError);};var getPrePageC2CHistoryMsgs=function(cbOk,cbError){if(selType==webim.SESSION_TYPE.GROUP){alert('当前的聊天类型为群聊天，不能进行拉取好友历史消息操作');return;}var tempInfo=getPrePageC2CHistroyMsgInfoMap[selToID];var lastMsgTime;var msgKey;if(tempInfo){lastMsgTime=tempInfo.LastMsgTime;msgKey=tempInfo.MsgKey;}else{alert('获取下一次拉取的c2c消息时间和消息Key为空');return;}var options={'Peer_Account':selToID,'MaxCnt':reqMsgCount,'LastMsgTime':lastMsgTime,'MsgKey':msgKey};webim.getC2CHistoryMsgs(options,function(resp){var complete=resp.Complete;if(resp.MsgList.length==0){webim.Log.warn("没有历史消息了:data="+JSON.stringify(options));return;}getPrePageC2CHistroyMsgInfoMap[selToID]={'LastMsgTime':resp.LastMsgTime,'MsgKey':resp.MsgKey};if(cbOk){cbOk(resp.MsgList);}else{getHistoryMsgCallback(resp.MsgList,true);}},cbError);};var getLastGroupHistoryMsgs=function(cbOk){if(selType==webim.SESSION_TYPE.C2C){alert('当前的聊天类型为好友聊天，不能进行拉取群历史消息操作');return;}getGroupInfo(selToID,function(resp){var options={'GroupId':selToID,'ReqMsgSeq':resp.GroupInfo[0].NextMsgSeq-1,'ReqMsgNumber':reqMsgCount};if(options.ReqMsgSeq==null||options.ReqMsgSeq==undefined||options.ReqMsgSeq<=0){webim.Log.warn("该群还没有历史消息:options="+JSON.stringify(options));return;}selSess=null;webim.MsgStore.delSessByTypeId(selType,selToID);recentSessMap[webim.SESSION_TYPE.GROUP+"_"+selToID]={};recentSessMap[webim.SESSION_TYPE.GROUP+"_"+selToID].MsgGroupReadedSeq=resp.GroupInfo&&resp.GroupInfo[0]&&resp.GroupInfo[0].MsgSeq;webim.syncGroupMsgs(options,function(msgList){if(msgList.length==0){webim.Log.warn("该群没有历史消息了:options="+JSON.stringify(options));return;}var msgSeq=msgList[0].seq-1;getPrePageGroupHistroyMsgInfoMap[selToID]={"ReqMsgSeq":msgSeq};document.getElementsByClassName("msgflow")[0].innerHTML="";if(cbOk)cbOk(msgList);},function(err){alert(err.ErrorInfo);});});};var getPrePageGroupHistoryMsgs=function(cbOk){if(selType==webim.SESSION_TYPE.C2C){alert('当前的聊天类型为好友聊天，不能进行拉取群历史消息操作');return;}var tempInfo=getPrePageGroupHistroyMsgInfoMap[selToID];var reqMsgSeq;if(tempInfo){reqMsgSeq=tempInfo.ReqMsgSeq;if(reqMsgSeq<=0){webim.Log.warn('该群没有历史消息可拉取了');return;}}else{webim.Log.error('获取下一次拉取的群消息seq为空');return;}var options={'GroupId':selToID,'ReqMsgSeq':reqMsgSeq,'ReqMsgNumber':reqMsgCount};webim.syncGroupMsgs(options,function(msgList){if(msgList.length==0){webim.Log.warn("该群没有历史消息了:options="+JSON.stringify(options));return;}var msgSeq=msgList[0].seq-1;getPrePageGroupHistroyMsgInfoMap[selToID]={"ReqMsgSeq":msgSeq};if(cbOk){cbOk(msgList);}else{getHistoryMsgCallback(msgList,true);}},function(err){alert(err.ErrorInfo);});};