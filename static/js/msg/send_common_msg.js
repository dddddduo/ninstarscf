function onSendMsg(){if(!selToID){alert("你还没有选中好友或者群组，暂不能聊天");$("#send_msg_text").val('');return;}var msgContent=document.getElementsByClassName("msgedit")[0].value;var msgLen=webim.Tool.getStrBytes(msgContent);if(msgContent.length<1){alert("发送的消息不能为空!");$("#send_msg_text").val('');return;}var maxLen,errInfo;if(selType==webim.SESSION_TYPE.C2C){maxLen=webim.MSG_MAX_LENGTH.C2C;errInfo="消息长度超出限制(最多"+Math.round(maxLen/3)+"汉字)";}else{maxLen=webim.MSG_MAX_LENGTH.GROUP;errInfo="消息长度超出限制(最多"+Math.round(maxLen/3)+"汉字)";}if(msgLen>maxLen){alert(errInfo);return;}handleMsgSend(msgContent);}function handleMsgSend(msgContent){if(!selSess){var selSess=new webim.Session(selType,selToID,selToID,friendHeadUrl,Math.round(new Date().getTime()/1000));}var isSend=true;var seq=-1;var random=Math.round(Math.random()*4294967296);var msgTime=Math.round(new Date().getTime()/1000);var subType;if(selType==webim.SESSION_TYPE.C2C){subType=webim.C2C_MSG_SUB_TYPE.COMMON;}else{subType=webim.GROUP_MSG_SUB_TYPE.COMMON;}var msg=new webim.Msg(selSess,isSend,seq,random,msgTime,loginInfo.identifier,subType,loginInfo.identifierNick);var text_obj,face_obj,tmsg,emotionIndex,emotion,restMsgIndex;var expr=/\[[^[\]]{1,3}\]/mg;var emotions=msgContent.match(expr);if(!emotions||emotions.length<1){text_obj=new webim.Msg.Elem.Text(msgContent);msg.addText(text_obj);}else{for(var i=0;i<emotions.length;i++){tmsg=msgContent.substring(0,msgContent.indexOf(emotions[i]));if(tmsg){text_obj=new webim.Msg.Elem.Text(tmsg);msg.addText(text_obj);}emotionIndex=webim.EmotionDataIndexs[emotions[i]];emotion=webim.Emotions[emotionIndex];if(emotion){face_obj=new webim.Msg.Elem.Face(emotionIndex,emotions[i]);msg.addFace(face_obj);}else{text_obj=new webim.Msg.Elem.Text(emotions[i]);msg.addText(text_obj);}restMsgIndex=msgContent.indexOf(emotions[i])+emotions[i].length;msgContent=msgContent.substring(restMsgIndex);}if(msgContent){text_obj=new webim.Msg.Elem.Text(msgContent);msg.addText(text_obj);}}msg.PushInfo={"PushFlag":0,"Desc":'测试离线推送内容',"Ext":'测试离线推送透传内容',"AndroidInfo":{"Sound":"android.mp3"},"ApnsInfo":{"Sound":"apns.mp3","BadgeMode":1}};msg.PushInfoBoolean=true;msg.sending=1;msg.originContent=msgContent;addMsg(msg);$("#send_msg_text").val('');turnoffFaces_box();webim.sendMsg(msg,function(resp){$("#id_"+msg.random).find(".spinner").remove();webim.Tool.setCookie("tmpmsg_"+selToID,'',0);},function(err){showReSend(msg);});}function showReSend(msg){var resendBtn=$('<a href="javascript:;">重发</a>');resendBtn.click(function(){$("#id_"+msg.random).remove();handleMsgSend(msg.originContent);});$("#id_"+msg.random).find(".spinner").empty().append(resendBtn);}function onTextareaKeyDown(){if(event.keyCode==13){onSendMsg();}}function onClose(){document.getElementById("webim_demo").style.display="none";webim.logout();}var showEmotionDialog=function(){if(emotionFlag){$('#wl_faces_box').css({"display":"block"});return;}emotionFlag=true;for(var index in webim.Emotions){var emotions=$('<img>').attr({"id":webim.Emotions[index][0],"src":webim.Emotions[index][1],"style":"cursor:pointer;"}).click(function(){selectEmotionImg(this);});$('<li>').append(emotions).appendTo($('#emotionUL'));}$('#wl_faces_box').css({"display":"block"});};var turnoffFaces_box=function(){$("#wl_faces_box").fadeOut("slow");};var selectEmotionImg=function(selImg){var txt=document.getElementsByClassName("msgedit")[0];txt.value=txt.value+selImg.id;txt.focus();};