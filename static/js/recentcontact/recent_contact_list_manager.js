function initGetRecentContactListTable(data){$('#get_recent_contact_list_table').bootstrapTable({method:'get',cache:false,height:500,striped:true,pagination:true,pageSize:pageSize,pageNumber:1,pageList:[10,20,50,100],search:true,showColumns:true,clickToSelect:true,columns:[{field:"SessionType",title:"会话类型(英文)",align:"center",valign:"middle",sortable:"true",visible:false},{field:"SessionTypeZh",title:"会话类型",align:"center",valign:"middle",sortable:"true"},{field:"SessionId",title:"会话ID",align:"center",valign:"middle",sortable:"true"},{field:"SessionNick",title:"会话昵称",align:"center",valign:"middle",sortable:"true"},{field:"SessionImage",title:"会话头像",align:"center",valign:"middle",sortable:"true",visible:false},{field:"C2cAccount",title:"发送者ID",align:"center",valign:"middle",sortable:"true"},{field:"C2cNick",title:"发送者昵称",align:"center",valign:"middle",sortable:"true"},{field:"UnreadMsgCount",title:"未读数",align:"center",valign:"middle",sortable:"true"},{field:"MsgSeq",title:"Seq",align:"center",valign:"middle",sortable:"true"},{field:"MsgRandom",title:"Random",align:"center",valign:"middle",sortable:"true"},{field:"MsgTimeStamp",title:"时间",align:"center",valign:"middle",sortable:"true"},{field:"MsgShow",title:"内容",align:"center",valign:"middle",sortable:"true"}],data:data,formatNoMatches:function(){return'无符合条件的记录';}});}var getRecentContactList=function(){initGetRecentContactListTable([]);var options={'Count':reqRecentSessCount};webim.getRecentContactList(options,function(resp){var data=[];var tempSess,tempSessMap={};if(resp.SessionItem&&resp.SessionItem.length>0){for(var i in resp.SessionItem){var item=resp.SessionItem[i];var type=item.Type;var sessType,typeZh,sessionId,sessionNick='',sessionImage='',senderId='',senderNick='';if(type==webim.RECENT_CONTACT_TYPE.C2C){typeZh='私聊';sessType=webim.SESSION_TYPE.C2C;sessionId=item.To_Account;if(sessionId=='@TIM#SYSTEM'){webim.Log.warn('过滤好友系统消息,sessionId='+sessionId);continue;}var key=sessType+"_"+sessionId;var c2cInfo=infoMap[key];if(c2cInfo&&c2cInfo.name){sessionNick=c2cInfo.name;}else{sessionNick=sessionId;}if(c2cInfo&&c2cInfo.image){sessionImage=c2cInfo.image;}else{sessionImage=friendHeadUrl;}senderId=senderNick='';}else if(type==webim.RECENT_CONTACT_TYPE.GROUP){typeZh='群聊';sessType=webim.SESSION_TYPE.GROUP;sessionId=item.ToAccount;sessionNick=item.GroupNick;if(item.GroupImage){sessionImage=item.GroupImage;}else{var key=sessType+"_"+sessionId;var groupInfo=infoMap[key];if(groupInfo&&groupInfo.image){sessionImage=groupInfo.image}else{sessionImage=groupHeadUrl;}}senderId=item.MsgGroupFrom_Account;if(!senderId){webim.Log.warn('群消息发送者id为空,senderId='+senderId+",groupid="+sessionId);continue;}if(senderId=='@TIM#SYSTEM'){webim.Log.warn('过滤群系统消息,senderId='+senderId+",groupid="+sessionId);continue;}senderNick=item.MsgGroupFromCardName;if(!senderNick){senderNick=item.MsgGroupFromNickName;if(!senderNick){var key=webim.SESSION_TYPE.C2C+"_"+senderId;var c2cInfo=infoMap[key];if(c2cInfo&&c2cInfo.name){senderNick=c2cInfo.name;}else{sessionNick=senderId;}}}}else{typeZh='未知类型';sessionId=item.ToAccount;}if(!sessionId){webim.Log.warn('会话id为空,sessionId='+sessionId);continue;}if(sessionId=='@TLS#NOT_FOUND'){webim.Log.warn('会话id不存在,sessionId='+sessionId);continue;}if(sessionNick.length>maxNameLen){sessionNick=sessionNick.substr(0,maxNameLen)+"...";}tempSess=tempSessMap[sessType+"_"+sessionId];if(!tempSess){tempSessMap[sessType+"_"+sessionId]=true;data.push({SessionType:sessType,SessionTypeZh:typeZh,SessionId:webim.Tool.formatText2Html(sessionId),SessionNick:webim.Tool.formatText2Html(sessionNick),SessionImage:sessionImage,C2cAccount:webim.Tool.formatText2Html(senderId),C2cNick:webim.Tool.formatText2Html(senderNick),UnreadMsgCount:item.UnreadMsgCount,MsgSeq:item.MsgSeq,MsgRandom:item.MsgRandom,MsgTimeStamp:webim.Tool.formatTimeStamp(item.MsgTimeStamp),MsgShow:item.MsgShow});console.log(data)}}}$('#get_recent_contact_list_table').bootstrapTable('load',data);$('#get_recent_contact_list_dialog').modal('show');},function(err){alert(err.ErrorInfo);});};var initRecentContactList=function(cbOK,cbErr){var options={'Count':reqRecentSessCount};webim.getRecentContactList(options,function(resp){var tempSess;var firstSessType;var firstSessId;var sessList=document.getElementsByClassName("sesslist")[0];sessList.innerHTML="";if(resp.SessionItem&&resp.SessionItem.length>0){for(var i in resp.SessionItem){var item=resp.SessionItem[i];var type=item.Type;var sessType,typeZh,sessionId,sessionNick='',sessionImage='',senderId='',senderNick='';if(type==webim.RECENT_CONTACT_TYPE.C2C){typeZh='私聊';sessType=webim.SESSION_TYPE.C2C;sessionId=item.To_Account;if(sessionId=='@TIM#SYSTEM'){webim.Log.warn('过滤好友系统消息,sessionId='+sessionId);continue;}var key=sessType+"_"+sessionId;var c2cInfo=infoMap[key];if(c2cInfo&&c2cInfo.name){sessionNick=c2cInfo.name;}else{sessionNick=sessionId;}if(c2cInfo&&c2cInfo.image){sessionImage=c2cInfo.image;}else{sessionImage=friendHeadUrl;}senderId=senderNick='';}else if(type==webim.RECENT_CONTACT_TYPE.GROUP){typeZh='群聊';sessType=webim.SESSION_TYPE.GROUP;sessionId=item.ToAccount;sessionNick=item.GroupNick;if(item.GroupImage){sessionImage=item.GroupImage;}else{var key=sessType+"_"+sessionId;var groupInfo=infoMap[key];if(groupInfo&&groupInfo.image){sessionImage=groupInfo.image}else{sessionImage=groupHeadUrl;}}senderId=item.MsgGroupFrom_Account;if(!senderId){webim.Log.warn('群消息发送者id为空,senderId='+senderId+",groupid="+sessionId);continue;}if(senderId=='@TIM#SYSTEM'){webim.Log.warn('过滤群系统消息,senderId='+senderId+",groupid="+sessionId);continue;}senderNick=item.MsgGroupFromCardName;if(!senderNick){senderNick=item.MsgGroupFromNickName;if(!senderNick&&!sessionNick){var key=webim.SESSION_TYPE.C2C+"_"+senderId;var c2cInfo=infoMap[key];if(c2cInfo&&c2cInfo.name){senderNick=c2cInfo.name;}else{sessionNick=senderId;}}}}else{typeZh='未知类型';sessionId=item.ToAccount;}if(!sessionId){webim.Log.warn('会话id为空,sessionId='+sessionId);continue;}if(sessionId=='@TLS#NOT_FOUND'){webim.Log.warn('会话id不存在,sessionId='+sessionId);continue;}if(sessionNick.length>maxNameLen){sessionNick=sessionNick.substr(0,maxNameLen)+"...";}tempSess=recentSessMap[sessType+"_"+sessionId];if(!tempSess){if(!firstSessId){firstSessType=sessType;firstSessId=sessionId;}recentSessMap[sessType+"_"+sessionId]={SessionType:sessType,SessionId:sessionId,SessionNick:sessionNick,SessionImage:sessionImage,C2cAccount:senderId,C2cNick:senderNick,UnreadMsgCount:item.UnreadMsgCount,MsgSeq:item.MsgSeq,MsgRandom:item.MsgRandom,MsgTimeStamp:webim.Tool.formatTimeStamp(item.MsgTimeStamp),MsgGroupReadedSeq:item.MsgGroupReadedSeq||0,MsgShow:item.MsgShow};addSess(sessType,webim.Tool.formatText2Html(sessionId),webim.Tool.formatText2Html(sessionNick),sessionImage,item.UnreadMsgCount,'sesslist');}}document.getElementsByClassName("msgflow")[0].innerHTML="";tempSess=recentSessMap[firstSessType+"_"+firstSessId];selType=tempSess.SessionType;selToID=tempSess.SessionId;selSess=webim.MsgStore.sessByTypeId(selType,selToID);setSelSessStyleOn(selToID);webim.syncMsgs(initUnreadMsgCount);if(cbOK)cbOK();}},cbErr);};function initUnreadMsgCount(){var sess;var sessMap=webim.MsgStore.sessMap();for(var i in sessMap){sess=sessMap[i];if(selToID&&selToID!=sess.id()){updateSessDiv(sess.type(),sess.id(),sess.name(),sess.unread());}}}